$(document).ready(function(){});function focalL(a,b,d){var c=a[0].cross(a[1]),e=a[1].cross(a[2]),f=a[2].cross(a[3]),a=a[3].cross(a[0]),c=c.cross(f),e=e.cross(a);if(0===c.z||0===e.z)throw"The rectangle isn't in a perspective position";c.div(c.z);e.div(e.z);b=-(c.x-b)*(e.x-b)-(c.y-d)*(e.y-d);return 0<=b?Math.sqrt(b):0}
function HomographyFrom4Pts(a){var b=[];b[0]=[0,0,1,0,0,0,0,0,-a[0].x];b[1]=[0,0,0,0,0,1,0,0,-a[0].y];b[2]=[0,1,1,0,0,0,0,-a[1].x,-a[1].x];b[3]=[0,0,0,0,1,1,0,-a[1].y,-a[1].y];b[4]=[1,1,1,0,0,0,-a[2].x,-a[2].x,-a[2].x];b[5]=[0,0,0,1,1,1,-a[2].y,-a[2].y,-a[2].y];b[6]=[1,0,1,0,0,0,-a[3].x,0,-a[3].x];b[7]=[0,0,0,1,0,1,-a[3].y,0,-a[3].y];a=numeric.transpose(b);b=numeric.dot(a,b);b=numeric.svd(b);a=b.V[8][8];return[[b.V[0][8]/a,b.V[1][8]/a,b.V[2][8]/a],[b.V[3][8]/a,b.V[4][8]/a,b.V[5][8]/a],[b.V[6][8]/
a,b.V[7][8]/a,1]]}function InternalMatrixInverse(a,b,d,c){var e=1/a,a=1/(a*b);return[[e,0,-d*e],[0,a,-c*a],[0,0,1]]}
function ProjectionM(a,b){var d=0.5*b.w,c=0.5*b.h,e=focalL(a,d,c);$("#localLength").val(e.toString());try{var f=HomographyFrom4Pts(a,d,c),j=InternalMatrixInverse(e,1,d,c),g=numeric.dot(j,f),l=[g[0][0],g[1][0],g[2][0]],q=[g[0][1],g[1][1],g[2][1]],k=numeric.norm2(l);numeric.norm2(q);var h=numeric.div(l,k),i=numeric.div(q,k),m=[h[1]*i[2]-h[2]*i[1],h[2]*i[0]-h[0]*i[2],h[0]*i[2]-h[2]*i[0]],n=[g[0][2]/k,g[1][2]/k,g[2][2]/k];return numeric.dot([[e,0,d],[0,e,c],[0,0,1]],[[h[0],i[0],m[0],n[0]],[h[1],i[1],
m[1],n[1]],[h[2],i[2],m[2],n[2]]])}catch(r){return alert("Error: "+r),[]}}function drawPoint(a,b){a.ellipse(b.x,b.y,5,5)}function drawLine(a,b,d){a.line(b.x,b.y,d.x,d.y)}
function drawCube(a,b,d){var c=numeric.dot(a,[0,0,1,1]),e=numeric.dot(a,[0,1,1,1]),f=numeric.dot(a,[1,1,1,1]),a=numeric.dot(a,[1,0,1,1]),c=new b.PVector(c[0]/c[2],c[1]/c[2]),e=new b.PVector(e[0]/e[2],e[1]/e[2]),f=new b.PVector(f[0]/f[2],f[1]/f[2]),a=new b.PVector(a[0]/a[2],a[1]/a[2]);drawLine(b,c,e);drawLine(b,e,f);drawLine(b,f,a);drawLine(b,a,c);drawLine(b,d[0],c);drawLine(b,d[1],e);drawLine(b,d[2],f);drawLine(b,d[3],a)}function Distance(a,b){var d=a.x-b.x,c=a.y-b.y;return Math.sqrt(d*d+c*c)}
function minDistance(a,b){for(var d=a.length,c=1E5,e=0,f=0;f<d;f++){var j=Distance(b,a[f]);j<c&&(c=j,e=f)}return e}var mousePressed=!1,idxMin=0;
function sketchProc(a){for(var b,d=Array(4),c=0;4>c;c++)d[c]=new a.PVector(0,0,1);var e=-1,f=!1;a.setup=function(){b=a.loadImage("Images/t5.JPG")};var j;a.draw=function(){try{a.size(b.width,b.height);a.image(b,0,0);for(var c=0;c<d.length;c++)e>=c&&(drawPoint(a,d[c]),1<=c&&(c<d.length&&drawLine(a,d[c],d[c-1]),c===d.length-1&&drawLine(a,d[c],d[0])));e===d.length-1&&!1===f&&(f=!0,j=ProjectionM(d,{w:b.width,h:b.height}));!0===f&&drawCube(j,a,d)}catch(l){alert(l.toString())}};a.mouseReleased=function(){if(e<
d.length-1){e++;for(var b=0;b<d.length;b++)e===b&&(d[b].x=a.mouseX,d[b].y=a.mouseY)}};a.mousePressed=function(){if(!0===f){mousePressed=!0;var b=new a.PVector(0,0,1);b.x=a.mouseX;b.y=a.mouseY;idxMin=minDistance(d,b)}};a.mouseDragged=function(){!0===mousePressed&&(d[idxMin].x=a.mouseX,d[idxMin].y=a.mouseY,j=ProjectionM(d,{w:b.width,h:b.height}))}}var canvas=document.getElementById("canvas1"),p=new Processing(canvas,sketchProc);